---
title: å°ç¨‹åºäº‘å¼€å‘
date: 2020-07-08 18:40:20
categories: å°ç¨‹åº
top: false
summary: å°ç¨‹åºäº‘å¼€å‘
tags: 
 - å°ç¨‹åº
---

## å°ç¨‹åºäº‘å¼€å‘

## ä¸€ã€ä¸ºä»€ä¹ˆè¦å­¦ä¹ äº‘å¼€å‘

ä¼ ç»Ÿå°ç¨‹åºå¼€å‘ï¼Œæˆ‘ä»¬è‡³å°‘å¾—è¦ä¸¤ä¸ªç¨‹åºå‘˜(å‰ç«¯ï¼Œåç«¯)ï¼Œæˆæœ¬é«˜ï¼Œè€Œä¸”å‰åç«¯åœ¨æ²Ÿé€šè¿‡ç¨‹ä¹Ÿè¦èŠ±å¾ˆå¤šçš„æ—¶é—´ï¼Œç”šè‡³è¶…è¿‡å„è‡ªçš„å¼€å‘å‘¨æœŸï¼Œè€Œä¸”ç›¸å¯¹äºæˆ‘ä»¬è¿™ç§å‰ç«¯ç¨‹åºå‘˜æ¥è¯´ï¼Œå¯¹åç«¯æŠ€æœ¯äº†è§£ä¸æ˜¯å¾ˆå¤šï¼Œè™½ç„¶æˆ‘ä»¬èƒ½å¤Ÿä½¿ç”¨`node`æ¥å¼€å‘æˆ‘ä»¬éœ€è¦çš„åç«¯ï¼Œä½†æˆ‘ä»¬è¿˜æ˜¯è·‘ä¸è¿‡è§£å†³åæœŸçš„ç»´æŠ¤ï¼Œä¾‹å¦‚

* è´­ä¹°æœåŠ¡å™¨ï¼ŒåŸŸåï¼ŒåŸŸåå¤‡æ¡ˆ
* ç½‘ç»œç»´æŠ¤
* è´Ÿè½½å‡è¡¡
* ç›‘æ§è­¦å‘Š

è¿™äº›å¤ªæŸç¼šæˆ‘ä»¬å‰ç«¯ç¨‹åºå‘˜å¼ºå¤§çš„ç¼–ç¨‹èƒ½åŠ›ï¼Œæˆ‘ä»¬æ˜¯è¦åšæœ€å¼ºçš„ç”·äººï¼Œè€Œå°ç¨‹åºäº‘å¼€å‘çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³æˆ‘ä»¬è¿™ç§ä¸å¤ªæ‡‚åç«¯çŸ¥è¯†ï¼Œä½†ä¹Ÿæƒ³å¼€å‘å‡ºä¸€ä¸ªé«˜é€¼æ ¼çš„å°ç¨‹åºäººå‘˜ã€‚

ä¼ ç»Ÿå¼€å‘æ¨¡å¼ï¼š

![ä¼ ç»Ÿå¼€å‘æ¨¡å¼](/medias/imges/xcx/cloud/img2.png)

> åœ¨ä¼ ç»Ÿçš„æ¨¡å¼ç”¨æˆ‘ä»¬è¦è§£å†³å¾ˆå¤šçš„åç«¯ç»´æŠ¤ï¼Œæˆæœ¬é«˜

äº‘å¼€å‘æ¨¡å¼ï¼š

![äº‘å¼€å‘æ¨¡å¼](/medias/imges/xcx/cloud/img1.png)

> åœ¨äº‘å¼€å‘æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨äº‘å¼€å‘ç»™æˆ‘ä»¬æä¾›çš„ `äº‘æ•°æ®åº“`ã€`äº‘å‡½æ•°`ã€`äº‘å­˜å‚¨`ã€`äº‘è°ƒç”¨`ã€`HTTP API`ä¸€äº›åŠŸèƒ½ï¼Œè®©æˆ‘ä»¬å‰ç«¯ç¨‹åºå‘˜ä¸ç”¨æ·±å…¥å­¦ä¹ åç«¯çŸ¥è¯†ï¼Œå°±èƒ½å€ŸåŠ©è¿™äº›å¼€å‘å‡ºä¸€ä¸ªå’Œéœ€è¦ç”¨å‰åç«¯å¼€å‘çš„å°ç¨‹åºä¸€æ ·ï¼Œè€Œä¸”æˆ‘ä»¬ä¸è¦ç®¡æœåŠ¡å™¨çš„æ­å»ºï¼ŒåæœŸçš„ç»´æŠ¤ï¼Œè®©æˆ‘ä»¬æ‹¨å¼€æŸç¼šï¼Œå¿«ä¹ç¼–ç ã€‚ğŸ˜„

äº‘å¼€å‘å„éƒ¨åˆ†çš„è§£é‡Šï¼š

* äº‘å‡½æ•°ï¼šåœ¨äº‘ç«¯è¿è¡Œçš„ä»£ç ï¼Œå¾®ä¿¡ç§æœ‰åè®®å¤©ç„¶é‰´æƒ
* äº‘æ•°æ®åº“ï¼šä¸€ä¸ªæ—¢å¯ä»¥åœ¨å°ç¨‹åºç«¯æ“ä½œåˆå¯ä»¥åœ¨äº‘å‡½æ•°ä¸­æ“ä½œçš„JSON æ•°æ®åº“(éå…³ç³»å‹æ•°æ®åº“ï¼Œç±»ä¼¼äº`mongodb`)
* äº‘å­˜å‚¨ï¼šåœ¨äº‘ç«¯å­˜å‚¨æ–‡ä»¶ï¼Œå¯ä»¥åœ¨äº‘ç«¯æ§åˆ¶å°å¯è§†åŒ–ç®¡ç†
* äº‘è°ƒç”¨ï¼šåŸºäºäº‘å‡½æ•°å…é‰´æƒä½¿ç”¨å°ç¨‹åºå¼€æ”¾æ¥å£çš„èƒ½åŠ›
* HTTP APIï¼šä½¿ç”¨HTTP API å¼€å‘è€…å¯åœ¨å·²åˆæœåŠ¡å™¨ä¸Šè®¿é—®äº‘èµ„æºï¼Œå®ç°äºäº‘å¼€å¼€å‘çš„äº’é€š

## äºŒã€å‘é€è¯·æ±‚

æˆ‘ä»¬é‡‡ç”¨`request `å’Œ`request-promise `ä¸¤ä¸ªåŒ…æ¥å‘é€æˆ‘ä»¬çš„ç½‘ç»œè¯·æ±‚ï¼Œ[githubåœ°å€](https://github.com/request/request-promise)

* ä¸‹è½½

```bash
npm i request request-promise -S
```

* ä½¿ç”¨

```js
// ç”±äº request-promise åŒ…å†…éƒ¨ä¾èµ–äº† promise åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬åªå¯¼å…¥ request-promise åŒ…å³å¯
const rp = require('request-promise')
// å‘é€è¯·æ±‚ å‚æ•°é…ç½®çœ‹ä¸Šæ–¹çš„ githubåœ°å€
rp(url)
```

## ä¸‰ã€äº‘å‡½æ•°è°ƒç”¨ä¸è·¯ç”±

æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯`tcb-router `çš„koaé£æ ¼è·¯ç”±

ä½¿ç”¨

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')
// å¯¼å…¥
const TcbRouter = require('tcb-router')
cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
  const app = new TcbRouter({
    event
  })
// å…¨å±€ä¸­é—´ä»¶
  app.use(async(ctx,next)=>{
    console.log('ctxçš„å€¼',ctx)
    ctx.data = {}
    ctx.data.openId = event.userInfo.openId
    await next()
  })
// åŒ¹é…çš„musicè·¯ç”±
  app.router('music',async(ctx,next) => {
    ctx.data.musicName = 'æ•°é¸­å­'
    await next()
  },async(ctx,next) => {
    ctx.data.musicType = 'å„¿æ­Œ'
    ctx.body = {
      data:ctx.data
    }
  })
// åŒ¹é…çš„movieè·¯ç”±
app.router('movie', async (ctx, next) => {
  ctx.data.movieName = 'åƒä¸åƒå¯»'
  await next()
}, async (ctx, next) => {
  ctx.data.movieType = 'æ—¥æœ¬åŠ¨ç”»ç‰‡'
  ctx.body = {
    data: ctx.data
  }
})
  // ä¸€å®šè¦è¿™ä¸ªè¾“å‡º
  return app.serve()
}

```

* é¡µé¢ç»“æ„

```html
<button type="primary" bindtap="getMusic">ç‚¹å‡»è·å–éŸ³ä¹</button>
<button type="primary" bindtap="getMovie">ç‚¹å‡»è·å–ç”µå½±</button>
```

* é¡µé¢äº‹ä»¶è°ƒç”¨

```js
Page({
    async getMusic() {
        let musicInfo =  await wx.cloud.callFunction({
            name:'demo',
            data:{
                $url:'music'
            }
        })
        console.log(musicInfo)
    },
    async getMovie() {
        console.log('movie')
        let movieInfo = await wx.cloud.callFunction({
            name: 'demo',
            data: {
                $url: 'movie'
            }
        })
        console.log(movieInfo)
    }
})
```

* éœ€è¦æ³¨æ„çš„ç‚¹

  * åœ¨å°ç¨‹åºè°ƒç”¨äº‘å‡½æ•°é‡‡ç”¨`wx.cloud.callFunction({xxx})`,ä¾‹å¦‚ï¼š

  ```js
  wx.cloud.callFunction({
      // å¯¹åº”çš„äº‘å‡½æ•°åç§°
      name: 'demo',
      // ä¼ é€’ç»™äº‘å‡½æ•°çš„å‚æ•°
      data: {
   		// å¦‚æœé‡‡ç”¨ tcb-router çš„å½¢å¼ï¼Œè¿™é‡Œè¦ä¸è·¯ç”±åç§°å¯¹åº”ä¸Š
          $url: 'movie'
      }
  })
  // è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè°ƒç”¨äº‘å‡½æ•°ä¹‹åè¿”å›çš„ç»“æœï¼Œæœ‰ä¸¤ç§å½¢å¼æ¥æ”¶ï¼Œä¸€ç§æ˜¯å›è°ƒå½¢å¼ï¼Œä¸€ç§æ˜¯promiseå½¢å¼ï¼Œæ¨èé‡‡ç”¨promiseå½¢å¼æ¥æ”¶ï¼Œå³é‡‡ç”¨ async å’Œ await 
  ```

  * å°ç¨‹åºå±‚é¢è°ƒç”¨äº‘å‡½æ•°ä¼ é€’è¿‡æ¥çš„å€¼ï¼Œåœ¨äº‘å‡½æ•°ç”¨çš„`event`å¯¹è±¡ä¸­å¯ä»¥è·å–

  * åœ¨äº‘å‡½æ•°ä¸­è·å–åˆ°äº‘æ•°æ®åº“çš„æ•°æ®è¦ç»™`ctx.data`èµ‹å€¼ï¼Œæœ€ç»ˆéƒ½æ˜¯ç»™`ctx.body`èµ‹å€¼è¿”å›
  * åœ¨äº‘å‡½æ•°ä¸­å¯¼å‡ºè¦ç”¨`  return app.serve()`
  * åœ¨é¡µé¢äº‹ä»¶è°ƒç”¨äº‘å‡½æ•°ç”¨å‚æ•°**data**ä¸­çš„`$url`ä¼ å€¼ç”¨äºåŒºåˆ†ï¼Œå…¶å€¼è¦äºäº‘å‡½æ•°ä¸­çš„å®šä¹‰å¥½çš„`router`åä¸€è‡´ï¼Œæœ€é‡è¦çš„äº‹`$url`è¿™ä¸ªå‚æ•°åæ˜¯å›ºå®šçš„ï¼Œä¸å¯å˜

## å››ã€çªç ´äº‘å‡½æ•°æŸ¥è¯¢å’Œæ›´æ–°é™åˆ¶

åœ¨äº‘å‡½æ•°ä¸­ï¼Œä¸€æ¬¡æŸ¥è¯¢äº‘æ•°æ®åº“æœ€å¤šè¿”å›100æ¡æ•°æ®ï¼Œè€Œåœ¨å°ç¨‹åºç¯å¢ƒä¸­æœ€å¤šè¿”å›20æ¡æ•°æ®ï¼Œè€Œä¸”æˆ‘ä»¬åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ¬¡åªèƒ½æ’å…¥ä¸€æ¡æ•°æ®ï¼Œè¿™å°†æ˜¯å¯¹æˆ‘ä»¬å¼€å‘ä¸€ä¸ªå¤§çš„é™åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡å–å¾ªç¯æŸ¥è¯¢å’Œå¾ªç¯æ’å…¥æ¥è§£å†³è¿™äº›å½±å“æˆ‘ä»¬å¼€å‘çš„é™åˆ¶ï¼Œä»£ç å¦‚ä¸‹

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()
// åˆå§‹åŒ–äº‘æ•°æ®åº“
const db = cloud.database()
// å¯¼å…¥è¯·æ±‚
const rp = require('request-promise')
const URL = 'http://musicapi.xiecheng.live/personalized'
const playListCollection = db.collection('playList')
const MAX_LIMIT = 10
// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
    // å¾—åˆ°äº‘æ•°æ®çš„æ•°æ®æ€»æ¡æ•° 
    const countResult = await playListCollection.count()
    const total = countResult.total
    // è®¡ç®—å¾—å‡ºè¦å–å¤šå°‘æ¬¡
    const batchTimes = Math.ceil(total / MAX_LIMIT)
    // ä¸´æ—¶å­˜å‚¨äº‘æ•°æ®åº“å–å›æ¥çš„æ•°æ®
    const tasks = []
    // å°†è·å–æ•°æ®çš„è¯·æ±‚éƒ½ç»„æˆä¸€ä¸ªè¯·æ±‚promiseæ•°ç»„
    for(let i=0;i< batchTimes; i++) {
        let promise = playListCollection.skip(i* MAX_LIMIT).limit(MAX_LIMIT).get()
        tasks.push(promise)
    }

    // æœ€ç»ˆå°†äº‘æ•°æ®çš„æ•°æ®å­˜æ”¾çš„ä½ç½®
    let list = {
        data:[]
    }
    // ç”¨åˆšæ‰è¯·æ±‚åˆ°çš„promiseæ•°ç»„å»è¯·æ±‚å¾ªç¯å–æ•°æ®
    if(tasks.length > 0) {
        // æ‰§è¡Œæ¯ä¸ªpromise ä¹‹åè¿”å› åˆ°æ–°æ•°ç»„ä¸­å» æ‹¼æ¥æˆ[{},{}]å½¢å¼
        list = (await Promise.all(tasks)).reduce((acc,cur)=>{
            return {
                data:acc.data.concat(cur.data)
            }
        })
    }
    const playList = await rp(URL).then(res => {
        return JSON.parse(res).result
    })

    // æ’å…¥æ•°æ®å»é‡
    const newData = []
    for(let i=0,len1 = playList.length;i<len1;i++) {
        let flag = true
        for (let j = 0, len2 = list.data.length;j<len2;j++) {
            if(playList[i].id === list.data[j].id) {
                flag = false
                break
            }
        }
        if(flag) {
            newData.push(playList[i])
        }
    }
    console.log('å»é‡åçš„æ•°ç»„',newData)

    // æ’å…¥åˆ°äº‘æ•°æ®åº“ä¸­
    for (let i = 0, len = newData.length;i<len;i++) {
        await playListCollection.add({
            data:{
                // è¿™é‡Œ{...} å°†å¯¹è±¡æ‰€æœ‰çš„å±æ€§åˆ°æ”¾åˆ°è¿™ä¸ªdataå¯¹è±¡ä¸­
                ...playList[i],
                // è·å–çš„æœåŠ¡å™¨çš„æ—¶é—´
                createTime:db.serverDate(),
            }
        }).then(res => {
            console.log("æ’å…¥æˆåŠŸ")
        }).catch(err => {
            console.log("æ’å…¥å¤±è´¥")
        })
    }
    return newData.length
}
```

è¯´æ˜ï¼š

* Promise.all(promiseæ•°ç»„) -> æ–¹æ³•æ˜¯å°†ä¼ å…¥çš„promiseæ•°ç»„ä¸­çš„æ‰€æœ‰promiseéƒ½è¯·æ±‚æˆåŠŸåæ‹¼æˆä¸€ä¸ªæ•°æ®æ•°ç»„ï¼Œå½¢å¼æ˜¯`[{data:{xxx}},{data:{xxx}}]`
* db.serverDate() -> è·å–çš„å½“å‰æœåŠ¡å™¨æ—¶é—´

##äº”ã€è¿›åº¦æ¡ç»„ä»¶å°è£…

è¿›åº¦æ¡ç»„ä»¶å°è£…ä½¿ç”¨åˆ°çš„å®¹å™¨ï¼š

* movable-area  -> æ»‘åŠ¨åŒºåŸŸ
  * [movable-area ](https://developers.weixin.qq.com/miniprogram/dev/component/movable-area.html)
* movable-view  -> æ»‘åŠ¨æŒ‰é’®
  * direction -> å†³å®šæ°´å¹³æ–¹å¼è¿˜æ˜¯å‚ç›´
  * damping -> é˜»å°¼ç³»æ•° ï¼Œå€¼è¶Šå¤§æ»‘å¾—è¶Šå¿«
  * x -> æ»‘å—æŒ‰é’®èµ°çš„æ­¥æ•°ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®ä¸º`1ç§’èµ°å®½åº¦xå½“å‰ç§’æ•°`,1ç§’èµ°çš„å®½åº¦ = æ»‘åŠ¨åŒºåŸŸå®½åº¦ - æ»‘åŠ¨æŒ‰é’®å®½åº¦) / æ€»æ—¶é—´ x å½“å‰æ—¶é—´
  * [movable-view](https://developers.weixin.qq.com/miniprogram/dev/component/movable-view.html)
* progress  -> è¿›åº¦æ¡å®¹å™¨
  * stroke-width -> è®¾ç½®å®½åº¦
  * percent -> èµ°çš„å®½åº¦ï¼Œå•ä½ `%`
  * backgroundColor -> èƒŒæ™¯è‰²
  * activeColor -> èµ°è¿‡çš„å®½åº¦é¢œè‰²
  * [progress](https://developers.weixin.qq.com/miniprogram/dev/component/progress.html)

ç»“æ„ï¼š

```html
<view class="container">
  <text class="time">{{showTime.startTime}}</text>
  <!-- è¿›åº¦æ¡ -->
  <view class="control">
    <movable-area class="movable-area">
    <movable-view class="movable-view" direction="horizontal" damping="1000" x="{{movableDis}}" bindchange="onChange" bindtouchend="onTouchEnd" />
    </movable-area>
    <progress stroke-width="4" backgroundColor="#969696" activeColor="#fff" percent="{{progress}}"></progress>
  </view>
  <text class="time">{{showTime.endTime}}</text>
</view>
```

æ ·å¼ï¼š

```css
.container {
    display: flex;
    align-items: center;
    position: absolute;
    bottom: 30%;
    width: 100%;
}
/* é™¤å»å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ å°†å‰©ä½™çš„å®½åº¦éƒ½å æ»¡ */
.control {
    position: relative;
    flex: 1;
}
/* æ»‘åŠ¨åŒºåŸŸ */
.movable-area {
    width: 100%;
    height: 34rpx;
    position: absolute;
    bottom: -14rpx;
    left: 0;
}
/* æ»‘åŠ¨æŒ‰é’®ç›’å­ */
.movable-view {
    width: 36rpx;
    height: 36rpx;
    background: #fefefe;
    border-radius: 50%;
}
/* æ—¶é—´æ ·å¼ */
.time {
    width: 64rpx;
    padding: 0 20rpx;
    font-size: 24rpx;
    font-family: NotoSansHans-Regular;
    font-weight: 400;
    color: rgba(255, 255, 255, 1);
    line-height: 30rpx;
}

```

* ç”±äºä¸åŒè®¾å¤‡ä¸Šå¯æ»‘åŠ¨åŒºåŸŸ`movable-area `å’Œå¯æ»‘åŠ¨æŒ‰é’®`movable-view`çš„å€¼éƒ½ä¸åŒï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥åŠ¨æ€è·å–åˆ°å®ƒä»¬çš„å€¼

```js
// å¾—åˆ°è¿›åº¦æ¡åº”è¯¥èµ°å¤šå®½
_getMovableDis() {
    const query = this.createSelectorQuery()
    // æ³¨æ„ä¸‹é¢ä¸¤ä¸ªç»‘å®šæ˜¯classé€‰æ‹©å™¨ï¼Œè§„å®šå¿…é¡»æ€ä¹ˆå†™
    query.select('.movable-area').boundingClientRect()
    query.select('.movable-view').boundingClientRect()
    // æ‰§è¡Œä¸Šé¢ç»‘å®šçš„äº‹ä»¶ï¼Œå®ƒä¼šæŒ‰é¡ºåºè¿›è¡Œè§¦å‘ä¸Šé¢çš„ç»‘å®šäº‹ä»¶ï¼Œå¹¶ä¸”æ‰§è¡Œç»“æœæŒ‰æ•°ç»„å½¢å¼è¿”å›
    query.exec((rect) => {
        // rect å¯¹è±¡æœ‰å…³äºæ»‘åŠ¨åŒºåŸŸå’Œæ»‘åŠ¨æŒ‰é’®åœ¨é¡µé¢ä¸Šçš„å„ç§å±æ€§
        // console.log(rect)
        // ç”±äºè®¾å¤‡ä¸åŒï¼Œä¸”rpxæ˜¯ç›¸å¯¹å•ä½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡ä¸‹é¢çš„æ–¹å¼å¾—åˆ°è¿›åº¦æ¡åº”è¯¥å¤šå®½
        movableAreaWidth = rect[0].width
        movableViewWidth = rect[1].width
    })
}
```

## å…­ã€ èƒŒæ™¯éŸ³é¢‘ç®¡ç†å™¨ 

é€šè¿‡`wx.getBackgroundAudioManager()`è·å–**å…¨å±€å”¯ä¸€**çš„èƒŒæ™¯éŸ³é¢‘ç®¡ç†å™¨ã€‚

[è¯¦ç»†æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/api/media/background-audio/BackgroundAudioManager.html) 

å¸¸ç”¨æ“ä½œï¼š

```js
// å¾—åˆ°å…¨å±€å”¯ä¸€çš„èƒŒæ™¯éŸ³ä¹æ’­æ”¾å™¨
const backgroundAudioManager = wx.getBackgroundAudioManager()
// åœæ­¢å½“å‰éŸ³ä¹æ’­æ”¾
backgroundAudioManager.stop()
// è®¾ç½®éŸ³ä¹æ’­æ”¾çš„çº¿ä¸Šåœ°å€
backgroundAudioManager.src = currentPlayerMusicInfo[0].url
// è®¾ç½®åå°çš„æ’­æ”¾å™¨çš„æ ·å¼
// æ ‡é¢˜
backgroundAudioManager.title = currentMusicInfo.name
// å°é¢
backgroundAudioManager.coverImgUrl = currentMusicInfo.al.picUrl
// æ­Œæ‰‹å
backgroundAudioManager.singer = currentMusicInfo.ar[0].name
// ä¸“è¾‘å
backgroundAudioManager.epname = currentMusicInfo.al.name
// å¾—åˆ°éŸ³ä¹æ€»æ—¶é•¿ å•ä½ç§’
backgroundAudioManager.duration
// å¾—åˆ°å½“å‰éŸ³ä¹æ’­æ”¾åˆ°çš„æ—¶é•¿ å•ä½ç§’
backgroundAudioManager.currentTime
```

ç»‘å®šäº‹ä»¶ï¼šæ‰§è¡Œé¡ºåº ï¼š  onCanplay -> onPlay -> onTimeUpdate -> onPause -> onEnded

```js
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘æ’­æ”¾äº‹ä»¶
backgroundAudioManager.onPlay(()=>{
    console.log('onPlay')
})
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘åœæ­¢äº‹ä»¶
backgroundAudioManager.onStop(()=>{
    console.log('onStop')
})
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘æš‚åœäº‹ä»¶
backgroundAudioManager.onPause(()=>{
    console.log('onPause')
})
// ç›‘å¬éŸ³é¢‘åŠ è½½ä¸­äº‹ä»¶ã€‚å½“éŸ³é¢‘å› ä¸ºæ•°æ®ä¸è¶³ï¼Œéœ€è¦åœä¸‹æ¥åŠ è½½æ—¶ä¼šè§¦å‘
backgroundAudioManager.onWaiting(()=>{
    console.log('onWaiting')
})
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘è¿›å…¥å¯æ’­æ”¾çŠ¶æ€äº‹ä»¶ã€‚ ä½†ä¸ä¿è¯åé¢å¯ä»¥æµç•…æ’­æ”¾ 
backgroundAudioManager.onCanplay(()=>{
    // console.log('onCanplay')
    if(typeof backgroundAudioManager.duration !='undefined') {
        // å¾—åˆ°éŸ³ä¹æ€»æ—¶é•¿
       duration = backgroundAudioManager.duration
    }else {
        setTimeout(()=>{
           duration = backgroundAudioManager.duration
        },1000)
    }
})
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘æ’­æ”¾è¿›åº¦æ›´æ–°äº‹ä»¶ï¼Œåªæœ‰å°ç¨‹åºåœ¨å‰å°æ—¶ä¼šå›è°ƒã€‚
backgroundAudioManager.onTimeUpdate(()=>{
    console.log('onTimeUpdate')
})
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘è‡ªç„¶æ’­æ”¾ç»“æŸäº‹ä»¶
backgroundAudioManager.onEnded(()=>{
    console.log('onEnded')
})
// ç›‘å¬èƒŒæ™¯éŸ³é¢‘æ’­æ”¾é”™è¯¯äº‹ä»¶
backgroundAudioManager.onError(()=>{
    console.log('onTimeUpdate')
})
```

## ä¸ƒã€åœ¨å°ç¨‹åºä¸­ä½¿ç”¨iconfontå­—ä½“å›¾æ ‡

* https://www.iconfont.cn/ ä¸‹è½½å›¾æ ‡ï¼Œå¹¶å°†æ–‡ä»¶ååç¼€æ”¹ä¸º`iconfont.wxss`
* æ”¾åœ¨å°ç¨‹åºçš„ä¸`pages`åŒç›®å½•ä¸‹
* åœ¨`app.wxss`å…¨å±€æ ·å¼æ–‡ä»¶ä¸‹å¼•å…¥

```less
@import 'iconfont.wxss'
```

## å…«ã€å°ç¨‹åºç»„ä»¶é€šä¿¡

ä¸‹é¢æˆ‘ä»¥`l-progress `(è¿›åº¦æ¡ç»„ä»¶),`l-singerWord `(æ­Œè¯ç»„ä»¶)å’Œ`player`(é¡µé¢)æ¥è¡¨è¿°

### 8.1 çˆ¶å¾€å­ä¼ å€¼

ä¾‹å¦‚ï¼š`playeré¡µé¢`å¾€`l-progress`ç»„ä»¶ä¼ é€’å€¼

* åœ¨`player`é¡µé¢ä¸­çš„`data`èŠ‚ç‚¹ä¸‹å®šä¹‰`isSame`

```js
Page({
    data:{
        isSame:false
    }
})
```

* åœ¨é¡µé¢çš„`player.wxml`ä¸­çš„ç»„ä»¶æ ‡ç­¾ä¸Šç»‘å®šå±æ€§

```html
<l-progress isSame="{{isSame}}" />
```

* åœ¨`l-progress`ç»„ä»¶å†…éƒ¨çš„`propertie `èŠ‚ç‚¹æ¥æ”¶

```js
Component({
    properties: {
        isSame:Boolean
    }
})
```

> è¿™æ ·ä¾¿å®ç°çˆ¶å‘å­ä¼ å€¼ï¼Œåœ¨`l-progress`ç»„ä»¶ä¸­å¯ä»¥é€šè¿‡`this.properties.è¯¥å±æ€§ä¸‹çš„ä»»æ„å€¼`ï¼Œå¹¶ä¸”å®ƒæ˜¯å¯è¯»å¯å†™çš„å€¼ï¼Œæœ‰æ„æ€çš„æ˜¯ä½ ç”¨`this.data.isSame`ä¹Ÿæ˜¯èƒ½å¤Ÿè·å–åˆ°å¤–ç•Œä¼ é€’çš„å€¼ï¼Œå°ç¼–è®¤ä¸ºæ˜¯åœ¨å°ç¨‹åºä½å±‚å°†`data`å’Œ`properties`çš„åŸå‹æ”¾åœ¨äº†ä¸€ä¸ªåœ°æ–¹ï¼Œè¿™ä¸ªè¯´æ˜ç­‰ä»¥åå°ç¼–ææ¸…æ¥šåœ¨æ¥è¡¥å‘ï¼Œè€Œä¿®æ”¹`properties`çš„å€¼ä¾ç„¶æ˜¯é€šè¿‡`this.setData({isSame:xxx})`æ–¹æ³•

### 8.2 å­å¾€çˆ¶ä¼ å€¼

ä¾‹å¦‚ï¼š`l-progress`ç»„ä»¶ å¾€`playeré¡µé¢`ä¼ é€’å€¼

* åœ¨`player`é¡µé¢ä¸Šå®šä¹‰äº‹ä»¶

```js
Page({
    sendCurrentTime(e) {
        console.log('ä¼ é€’è¿‡æ¥çš„å€¼',e.detail.currentSec)
    }
})
```

* åœ¨`l-progress`æ ‡ç­¾ä¸Šç»‘å®šäº‹ä»¶

```html
<l-progress bindsendCurrentTime="sendCurrentTime" />
```

* åœ¨`l-progress`ç»„ä»·ä¸­åˆé€‚çš„ä½ç½®ä¸­è§¦å‘

```js
this.triggerEvent('sendCurrentTime', { currentSec:'1111'})
```

### 8.3 å…„å¼Ÿç»„ä»¶ä¼ å€¼ ï¼ˆ*ï¼‰

å…¶ä»–å…„å¼Ÿé—´ä¼ å€¼å’Œå­å¾€çˆ¶ä¼ å€¼æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œåªæ˜¯åœ¨çˆ¶ä¸­é‡‡ç”¨`this.selectComponent()`æ–¹æ³•é€‰ä¸­å¦ä¸€ä¸ªç»„ä»¶ï¼Œè§¦å‘é€‰ä¸­ç»„ä»¶ä¸Šçš„æ–¹æ³•ï¼Œå¹¶å°†æ•°æ®ä¼ é€’è¿‡å»ï¼Œ**æ³¨æ„ï¼šè¿™æ ·å­é€‰ä¸­çš„ç»„ä»¶åèƒ½å¤Ÿè·å–å®ƒå®šä¹‰ä¸­çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•**

ä¾‹å¦‚ï¼š`l-progress`ç»„ä»¶ å¾€`l-singerWord `ç»„ä»¶ä¼ é€’å½“å‰æ’­æ”¾æ—¶é—´

* åœ¨`player`é¡µé¢æ’’èŠ±å§‘å¨˜å®šä¹‰äº‹ä»¶

```js
Page({
    sendCurrentTime(e) {
        // å…³é”®ç‚¹
         this.selectComponent('.lyric').setSingetWord(e.detail.currentSec)
    }
})
```

* åœ¨`l-progress`æ ‡ç­¾ä¸Šç»‘å®šäº‹ä»¶

```html
<l-progress bindsendCurrentTime="sendCurrentTime" />
```

* åœ¨`l-progress`ç»„ä»·ä¸­åˆé€‚çš„ä½ç½®ä¸­è§¦å‘

```js
this.triggerEvent('sendCurrentTime', { currentSec:'1111'})
```

* åœ¨`l-singerWord `ç»„ä»¶ä¸­å®šä¹‰äº‹ä»¶

```js
Component({
    setSingetWord(currentTime) {
        // currentTime ç»„ä»¶l-progressä¼ é€’è¿‡æ¥çš„å€¼
        console.log(currentTime)
    }
})
```

## ä¹ã€å°ç¨‹åºçš„å‚æ•°æ¥æ”¶

### 9.1 æ¥æ”¶æŸä¸ªæ ‡ç­¾å…ƒç´ ä¸Šçš„è‡ªå®šä¹‰å±æ€§å€¼

* åœ¨æ ‡ç­¾ä¸Šç”¨`data-xx=xx`æ¥ä¼ é€’å‚æ•°

```html
<view class="sigerBox" bindtap="gotoMusicList" data-id="123">
</view>
```

* æ¥æ”¶ :é€šè¿‡`e.currentTarget.dataset.id`,è¿™é‡Œä¹Ÿæœ‰å¯èƒ½æ˜¯åœ¨`target`ä¸Šè¿™å¾—çœ‹è°è‡ªå®šä¹‰å‚æ•°æ˜¯ç»‘å®šåœ¨è§¦å‘è¯¥äº‹ä»¶å…ƒç´ ä¸Šï¼Œè¿˜æ˜¯ç»‘å®šåˆ°å…¶ä»–å…ƒç´ ä¸Šï¼Œå…¶å®å°±æ˜¯`äº‹ä»¶å†’æ³¡æœºåˆ¶`

```js
gotoMusicList(e) {
    console.log(e.currentTarget.dataset.id)
}
```

### 9.2 å¯¼èˆªåˆ°æŸä¸ªé¡µé¢ï¼Œè¯¥é¡µé¢å‚æ•°æ¥æ”¶

ä¾‹å¦‚å¯¼èˆªåˆ°

```js
wx.navigateTo({
    url: '/pages/musicList/musicList?id=123' 
})
```

æ¥æ”¶ï¼šé€šè¿‡ é¡µé¢çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°`onLoad`çš„å‚æ•°`options`æ¥æ”¶

```js
Page({
    onLoad: async function (options) {
        console.log(options)
    },
})
```

### 9.3 å­ç»„ä»¶å¾€çˆ¶ç»„ä»¶ä¸Šä¼ å€¼

è¿™éƒ¨åˆ†å¯çœ‹æœ¬ç« çš„`8.2å­å¾€çˆ¶ä¼ å€¼`å†…å®¹ï¼Œæ¥æ”¶å­ä¼ é€’è¿‡æ¥çš„æ•°æ®æ˜¯åœ¨çˆ¶ç»„ä»¶å®šä¹‰ä¸Šçš„äº‹ä»¶å¯¹è±¡ä¸­çš„`e.detail`ä¸Š

## åã€å¼€å‘ä¸­çš„ç»„ä»¶æ ·å¼é—®é¢˜

æˆ‘ä»¬éƒ½çŸ¥é“æˆ‘ä»¬å¯ä»¥å¼•å…¥å¤–éƒ¨çš„`.wxss`æ–‡ä»¶æ¥æ‰©å±•è‡ªå·±çš„æ ·å¼ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½å°†å¤–éƒ¨æ–‡ä»¶å¯¼å…¥`app.wxss`ä¸­å»æˆä¸ºå…¨å±€æ ·å¼ï¼Œè¿™æ ·æ‰€æœ‰çš„ç•Œé¢éƒ½èƒ½éƒ½å¼•ç”¨è¯¥æ–‡ä»¶çš„æ ·å¼ï¼Œä½†ç»„ä»¶å­˜åœ¨`æ ·å¼éš”ç¦»`ï¼Œå¤–éƒ¨çš„æ ·å¼å¹¶ä¸èƒ½å¤Ÿå½±å“åˆ°ç»„ä»¶ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸‰ç§æ–¹æ³•

###10.1 ç›´æ¥å¯¼å…¥æ ·å¼æ–‡ä»¶

 å°†å¤–éƒ¨æ–‡ä»¶å¯¼å…¥åˆ°ç»„ä»¶çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œåœ¨ç»„ä»¶å¯¹åº”çš„`.wxss`æ–‡ä»¶ä¸‹`@import`å¯¼å…¥ï¼Œæ ·å¼å³å¯ç”Ÿæ•ˆ

ç»„ä»¶ç›®å½•ï¼š

```js
inconfont.wxss
component.wxml
component.wxss
component.js
component.json
```

åœ¨`commponet.wxss`æ–‡ä»¶ä¸‹

```less
@import 'iconfont.wxss' // å¯¼å…¥
```

### 10.2 çˆ¶é¡µé¢ä¼ å…¥

ä¾‹å¦‚åœ¨`blog`é¡µé¢ä¸Šå¾€ç»„ä»¶`search`ä¼ é€’`iconfont`å’Œ`icon-sousuo `æ ·å¼

* åœ¨`blog`é¡µé¢ä¸Šç»™`search`ç»„ä»¶ä¸Šç»‘å®šå±æ€§ï¼Œè€Œä¸”å±æ€§åå­—è¦å’Œæ ·å¼ä¸€è‡´

```html
<l-search  iconfont="iconfont" icon-sousuo="icon-sousuo" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹" bindSearch="search" />
```

* åœ¨`search`ç»„ä»¶ä¸­å¼€å¯æ¥æ”¶æ ·å¼ï¼Œåœ¨`externalClasses`èŠ‚ç‚¹ä¸‹æ¥æ”¶

```js
Component({
    externalClasses: [
        'iconfont',
        'icon-sousuo',
    ],
})
```

* è€Œ`search` ç»„ä»¶é¡µé¢ä¸Šæ ·å¼ç”Ÿæ•ˆ,**è€Œè¿™ç§å¼•å…¥çš„æ ·å¼ï¼Œæˆ‘ä»¬éœ€è¦æ”¹å˜å®ƒçš„æ ·å¼å°±å¾—é€šè¿‡è‡ªå·±å®šä¹‰çš„ç±»æ¥è¦†ç›–**

```html
<view class="container">
    <i class="iconfont icon-sousuo find"></i>
</view>
```

### 10.3 å¼€å¯å¤–éƒ¨å½±å“

åœ¨ç»„ä»¶ä¸‹çš„`.js`æ–‡ä»¶å¼€å¯å¤–éƒ¨å½±å“ å…¶ä»–å‚æ•°çœ‹[æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html#%E7%BB%84%E4%BB%B6%E6%A0%B7%E5%BC%8F%E9%9A%94%E7%A6%BB)

```js
Component({
    options: {
        styleIsolation: 'apply-shared', // è¡¨ç¤ºé¡µé¢ wxss æ ·å¼å°†å½±å“åˆ°è‡ªå®šä¹‰ç»„ä»¶ï¼Œä½†è‡ªå®šä¹‰ç»„ä»¶ wxss ä¸­æŒ‡å®šçš„æ ·å¼ä¸ä¼šå½±å“é¡µé¢ï¼›
    },
})
```

##åä¸€ã€ç»„ä»¶å¼€å¯å¤šæ’æ§½

åœ¨`.js`æ–‡ä»¶ä¸‹`option`èŠ‚ç‚¹è®¾ç½®ä¸ºtrue

```js
Component({
    options: {
        // å¼€å¯å¤šæ’æ§½
        multipleSlots: true,
    },
})
```

## åäºŒã€ äº‘å¼€å‘ä¸­è°ƒç”¨çš„APi

### 12.1 è·å–ç”¨æˆ·ä¿¡æ¯ä¸ç”¨æˆ·æˆæƒä¿¡æ¯

**è·å–ç”¨æˆ·ä¿¡æ¯ï¼š**

* é€šè¿‡ [<open-data>](https://developers.weixin.qq.com/miniprogram/dev/component/open-data.html) æ ‡ç­¾æ¥å±•ç¤ºå½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œä½†åªèƒ½åœ¨`.wxml`æ–‡ä»¶ä¸­èµ·åˆ°å±•ç¤ºçš„ä½œç”¨ï¼Œåœ¨`.js`æ–‡ä»¶ä¸­è·å–ä¸åˆ°è¯¥æ ‡ç­¾æä¾›çš„æ‰€æœ‰ä¿¡æ¯

```html
<open-data type="userAvatarUrl" ></open-data>
```

* é€šè¿‡[wx.getSetting()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/user-info/wx.getUserInfo.html) è¯¥apiå¯åœ¨ç”¨æˆ·å·²æˆæƒä¸”æˆæƒè¿˜æœªè¿‡æœŸçš„æƒ…å†µä¸‹å¯è·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½†ä¸åŒ…å«`openId`,åœ¨ç”¨æˆ·æœªæˆæƒè¿‡çš„æƒ…å†µä¸‹è°ƒç”¨æ­¤æ¥å£ï¼Œå°†ä¸å†å‡ºç°æˆæƒå¼¹çª—ï¼Œä¼šç›´æ¥è¿›å…¥ fail å›è°ƒï¼ˆè¯¦è§[ã€Šå…¬å‘Šã€‹](https://developers.weixin.qq.com/community/develop/doc/0000a26e1aca6012e896a517556c01))ã€‚

```js
wx.getUserInfo({
    success:(res)=>{
        console.log(res)
    }
})
```

* é€šè¿‡`<button open-type="getUserInfo" bindgetuserinfo="getUserInfo">è·å–ç”¨æˆ·ä¿¡æ¯</button>`ï¼Œåœ¨buttonä¸Šç»‘å®š`open-type="getUserInfo"`å¹¶æ³¨å†Œäº‹ä»¶`bindgetUserInfo="getUserInfo"`ï¼Œè¿™ç§æ–¹å¼å¯å¾—åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½†ä¹Ÿå¾—ä¸åˆ°`openId`

```html
<button  open-type="getUserInfo" bindgetuserinfo="getUserInfo">è·å–ç”¨æˆ·ä¿¡æ¯</button>
```

```js
getUserInfo(e) {
    // e åŒ…å«ç”¨æˆ·ä¿¡æ¯
    console.log(e)
},
```

* é€šè¿‡è°ƒç”¨äº‘å‡½æ•°`login`è·å–åˆ°ç”¨æˆ·`openId`,è¿™æˆ‘ä»¬å¾—å…ˆæŠŠ`login`æ–‡ä»¶å¤¹ä¸Šä¼ åˆ°äº‘ç«¯æˆä¸ºäº‘å‡½æ•°æ‰å¯è°ƒç”¨

```js
<button bindtap="cloudGetOpenid">é€šè¿‡äº‘å‡½æ•°è·å–åˆ°ç”¨æˆ·çš„openid</button>
```

```js
async  cloudGetOpenid() {
    let openIdInfo =   await wx.cloud.callFunction({
        name:'login'
    })
    console.log(openIdInfo)
}
```

**è·å–æˆæƒä¿¡æ¯ï¼š**

æˆ‘ä»¬é‡‡ç”¨`wx.getSetting()`è¿”å›æ•°æ®ä¸­çš„`authSetting`èŠ‚ç‚¹ä¸‹å±æ€§æ¥è·å–åˆ°ç”¨æˆ·çš„æˆæƒä¿¡æ¯ï¼Œè¿›è¡Œé€»è¾‘åˆ¤æ–­

```js
wx.getSetting({
    success:(res)=>{
        console.log(res)
    }
})
```

### 12.2 å®ç°ä¸Šä¼ å›¾ç‰‡åŠŸèƒ½

å®ç°æ­¥éª¤:

* ä½¿ç”¨[wx.chooseImage()](https://developers.weixin.qq.com/miniprogram/dev/api/media/image/wx.chooseImage.html)æ¥é€‰æ‹©å›¾ç‰‡å¹¶å¾—åˆ°å›¾ç‰‡çš„ä¸´æ—¶è·¯å¾„ï¼Œå¯ç”¨äºå®ç°ç…§ç‰‡é¢„è§ˆåŠŸèƒ½
* å¾—åˆ°ä¸´æ—¶è·¯å¾„ï¼Œå½“æˆ‘ä»¬ç¡®è®¤ä¸Šä¼ å›¾ç‰‡åï¼Œé‡‡ç”¨`wx.cloud.uploadFile() `è°ƒç”¨apiæ¥å®ç°ä¸Šä¼ åˆ°äº‘å­˜å‚¨ä¸­å»

å®ä¾‹:

* ç»™å…ƒç´ ç»‘å®šé€‰æ‹©ç…§ç‰‡äº‹ä»¶

```html
<view bindtap="onchoseImages"></view>
<button class="send-btn" size="mini" bindtap="sendCloud">å‘å¸ƒ</button>
```

* ä¹¦å†™é€»è¾‘

```js
Page({
    data: {
        // è®¾ç½®å›¾ç‰‡ä¸´æ—¶å­˜å‚¨ä½ç½®
        imagesBox:[],
    },
    // ç›‘å¬é€‰æ‹©ç…§ç‰‡äº‹ä»¶
    onchoseImages() {
        wx.chooseImage({
            // æ¯æ¬¡ç‚¹å‡»èƒ½é€‰å‡ å¼ ï¼Œè¿™é‡Œè®¾ç½®ä¸ºä¸€æ¬¡åªèƒ½é€‰9å¼ 
            count: 9,
            // æ‰€é€‰çš„å›¾ç‰‡çš„å°ºå¯¸ åŸå›¾æˆ–å‹ç¼©
            sizeType:['original','compressed'],
            // é€‰æ‹©å›¾ç‰‡çš„æ¥æº æ‘„åƒæœºæˆ–ç›¸å†Œ
            sourceType:['album','camera'],
            success: (res)=>{
                // res ä¸­æœ‰tempFilePaths æ˜¯å›¾ç‰‡ä¸´æ—¶è·¯å¾„
                console.log(res)
                this.setData({
                    imagesBox: this.data.imagesBox.concat(res.tempFilePaths),
                })
            } 
        })
    },
})
```

* å®ç°å›¾ç‰‡çš„é¢„è§ˆåŠŸèƒ½é‡‡ç”¨` wx.previewImage`,ä¸€èˆ¬æˆ‘ä»¬éƒ½ç»™æ¯ä¸ªç…§ç‰‡ç»‘å®šç‚¹å‡»äº‹ä»¶

```html
<block wx:for="{{imagesBox}}" wx:key="*this">
    <view class="image-wrap">
        <image class="image" src="{{item}}" mode="aspectFill" bind:tap="onPreviewImage" data-imgsrc="{{item}}"></image>
        <i class="iconfont icon-shanchu" bind:tap="onDelImage" data-index="{{index}}"></i>
    </view>
</block>
```

```js
onPreviewImage() { 
    wx.previewImage({
        // æ‰€æœ‰å›¾ç‰‡çš„å­˜å‚¨ä½ç½® æ˜¯ä¸ªæ•°ç»„
        urls: this.data.imagesBox,
        // å½“å‰ç‚¹å‡»çš„å›¾ç‰‡è·¯å¾„ ä¸€ç­æˆ‘ä»¬è§å›¾ç‰‡çš„è·¯å¾„å½“åšå±æ€§ç»‘å®šåˆ°å…¶å…ƒç´ ä¸Šï¼Œæ–¹ä¾¿æˆ‘ä»¬ç‚¹å‡»ä¹‹åè·å–ä¿¡æ¯
        current:e.currentTarget.dataset.imgsrc
    })
}
```

* å°†å›¾ç‰‡ä¸Šä¼ åˆ°äº‘å­˜å‚¨ä¸­å»,ç”±äºæ¯ä¸€æ¬¡å‘é€åªèƒ½ä¸Šä¼ ä¸€å¼ ç…§ç‰‡ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å‘é€ï¼Œå¹¶ä½¿ç”¨`promise.all`æ¥åˆ¤æ–­å…¨éƒ¨ä¸Šä¼ æˆåŠŸä¹‹åï¼Œåœ¨å°†æ•°æ®æ’å…¥åˆ°äº‘æ•°æ®åº“ä¸­å»

```js
// æŠŠå›¾ç‰‡å‘é€åˆ°äº‘ç«¯
async sendCloud() {
    // å­˜æ”¾æ‰€æœ‰promiseå¯¹è±¡çš„æ•°ç»„
    let primiseArr = []
    // å­˜æ”¾fileIdæ•°ç»„
    let fileId = []
    for(let i=0,len=this.data.imagesBox.length;i<len;i++) {
        let p = new Promise(async (resolve, reject)=> {
            let item = this.data.imagesBox[i]
            // å¾—åˆ°æ–‡ä»¶åç¼€å
            let suffix = /\.\w+$/.exec(item)[0]
            await wx.cloud.uploadFile({
                // è¿™é‡Œæ˜¯æŒ‡æ–‡ä»¶ä¸Šä¼ ä¹‹åçš„ä½ç½®å’Œåå­— 
                cloudPath: 'blog/' + Date.now() + '-' + Math.floor(Math.random() * 100000) + suffix,
                // å›¾ç‰‡ä¸´æ—¶å­˜æ”¾è·¯å¾„
                filePath: item,
                success: (res) => {
                    // res æ˜¯äº‘å­˜å‚¨æˆåŠŸä¹‹åè¿”å›çš„æ–‡ä»¶å­˜å‚¨å­¦ä¹  ï¼ŒfileID æ˜¯æ–‡ä»¶çš„å”¯ä¸€å­˜å‚¨ä¿¡æ¯
                    console.log(res)
                    let curFileId = res.fileID
                    fileId.push(curFileId)
                    resolve()
                },
                fail:(err) => {
                    console.log(err)
                    reject(err)
                }
            })
        })
        primiseArr.push(p)
    }

    // åˆ¤æ–­æ˜¯å¦å…¨éƒ¨ä¸Šä¼ æˆåŠŸ
    Promise.all(primiseArr).then(async (res) => {
        let addBlogInfo =  await db.collection('blog').add({
            data:{
                ...userInfo,
                content: content,
                img:fileId,
                createTime:db.serverDate()
            }
        })
```

### 12.3 å®ç°è®¢é˜…æ¨¡æ¿ä¿¡æ¯æ¨é€

> æ¦‚å¿µï¼šå½“å‰æˆ‘ä»¬åªèƒ½ä½¿ç”¨ä¸€æ¬¡æ€§è®¢é˜…æ¶ˆæ¯ç±»å‹çš„è®¢é˜…æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬å‹¾é€‰äº†å…è®¸è®¢é˜…æ¶ˆæ¯å¹¶ä¿æŒä¸åœ¨å’¨è¯¢ä¹‹åï¼Œç”¨æˆ·æœ‰ä¸€å®šçš„è¯¥æ¨¡æ¿çš„è®¢é˜…æ¬¡æ•°ï¼Œå½“è®¢é˜…æ¬¡æ•°ç”¨å®Œï¼Œå°±éƒ½ä¼šæŠ¥`43101`é”™è¯¯ç ï¼Œè¿™æ˜¯æˆ‘ä»¬å°±çš„äººä¸ºçš„æ‰‹åŠ¨å¢åŠ è®¢é˜…æ¬¡æ•°ï¼Œé€šè¿‡è°ƒç”¨`  wx.requestSubscribeMessage()`API

1. å…ˆåœ¨å¾®ä¿¡å…¬ä¼—å·å¹³å°ä¸Šå¼€é€š[è®¢é˜…ä¿¡æ¯åŠŸèƒ½](https://mp.weixin.qq.com/wxamp/newtmpl/mytmpl?start=0&limit=10&token=381636637&lang=zh_CN)

2. [æ›´åŠ æ–‡æ¡£å¼€å‘](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/subscribe-message.html)

   * é€‰æ‹©å¥½è®¢é˜…æ¶ˆæ¯æ¨é€æ¨¡æ¿
   * æ¨é€ç»“æ„æ¨èè¿™ç§å†™æ³•ï¼Œç”¨`form`å’Œ`button`æ¥è§¦å‘`submit`ç»‘å®šçš„äº‹ä»¶

```html
   <form slot="modal-content"  report-submit="true" bind:submit="onSend" >
       <textarea name="content" class="comment-content" placeholder="å†™è¯„è®º" value="{{content}}" fixed="true" bindinput="onCommentValue"></textarea>
       <button class="send" form-type="submit" size="mini" >å‘é€</button>
   </form>
```

   * å°ç¨‹åºç«¯è°ƒç”¨äº‘å‡½æ•°

```js
   async onSend(e) {
       // å¾—åˆ°è¯„è®ºå†…å®¹
       let content = e.detail.value.content
       // æ¨é€æ¨¡æ¿æ¶ˆæ¯
       await wx.cloud.callFunction({
           name:'sendMessage',
           data:{
               content,
               blogId: this.properties.blogId,
           }
       })
       console.log(templateInfo)
   }
```

   * `wx.requestSubscribeMessage()` è®©ç”¨æˆ·æˆæƒè¯¥æ¨¡æ¿çš„id 

```js
   wx.requestSubscribeMessage({
       // æ¨¡æ¿id è¦å’Œä¸‹é¢çš„äº‘å‡½æ•°è°ƒç”¨çš„æ¨¡æ¿idä¸€è‡´
       tmplIds: ['giNbDI-65WcfHua6-Svz3XNRwJ3dHNTe2XieAJir31Y'],
       success(res) {
           wx.getSetting({
               success: (res) => {
                   console.log(res)
               }
           })
       }
   })
```

   * åœ¨æ¨é€æ¨¡æ¿çš„äº‘å‡½æ•°ä¸‹é…ç½®`config.json`æ–‡ä»¶ï¼Œç›®çš„æ˜¯å¯åŠ¨è¯¥apiåŠŸèƒ½

```json
{
  "permissions": {
   "openapi": [
    "subscribeMessage.send"
  ]
  }
}
```

   * åœ¨äº‘å‡½æ•°ä¸­è°ƒç”¨`cloud.openapi.subscribeMessage.send`æ–¹æ³•

```js
// äº‘å‡½æ•°å…¥å£æ–‡ä»¶
const cloud = require('wx-server-sdk')

cloud.init()

// äº‘å‡½æ•°å…¥å£å‡½æ•°
exports.main = async (event, context) => {
    let  result = await cloud.openapi.subscribeMessage.send({
        touser: cloud.getWXContext().OPENID,
        lang: 'zh_CN',
        // æ¨¡æ¿id  è¦å’Œ wx.requestSubscribeMessage() ä¸­çš„æ¨¡æ¿idä¸€è‡´
        templateId:'giNbDI-65WcfHua6-Svz3XNRwJ3dHNTe2XieAJir31Y',
        // ç”¨æˆ·ç‚¹å‡»æ¨¡æ¿è¦è·³è½¬çš„è·¯å¾„
        page: `/pages/blogDetail/blogDetail?blogId=${event.blogId}`,
        data:{
            // ä¿¡æ¯å¡«å†™ä½ç½® è¦å’Œæ‘¸å§å¯¹åº”ä¸Š
            thing2:{
                value: event.content
            },
            phrase1:{
                value:'è¯„ä»·æˆåŠŸ'
            },
        }

    })
    return {
        'success': result,
    }

}

```

### 12.4 å®ç°åˆ†äº«åŠŸèƒ½

* å®ç°åˆ†äº«åŠŸèƒ½çš„ç»“æ„ï¼Œç”¨`<button>`ç»„ä»¶æ¥è°ƒç”¨åˆ†äº«åŠŸèƒ½apiï¼Œå½“æˆ‘ä»¬ç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œå®ƒä¼šè§¦å‘æˆ‘ä»¬ç»„ä»¶æ‰€åœ¨å½“å‰é¡µé¢çš„`onShareAppMessage`åˆ†äº«äº‹ä»¶

```html
<view class="ctrl-item share">
    <button open-type="share" class="share-btn" data-blog="{{blog}}">
        <i class="iconfont icon-fenxiang icon"></i>
        <text>åˆ†äº«</text>
    </button>
</view>
```

* é¡µé¢çš„`onShareAppMessage `äº‹ä»¶é…ç½®

```js
onShareAppMessage: function (e) {
    // è·å–åˆ°åˆ†äº«æŒ‰é’®ä¸Šçš„å±æ€§å€¼
    const shartInfo = e.target.dataset.blog
    return {
        // åˆ†äº«æ ‡é¢˜
        title: shartInfo.content,
       // å½“ç”¨æˆ·ç‚¹å‡»åˆ†äº«é¡µé¢ä¼šè·³è½¬åˆ°çš„å°ç¨‹åºé¡µé¢
        page: `/pages/blogDetail/blogDetail?id=${shartInfo._id}`
    }
}
```

### 12.5 ç”Ÿæˆå°ç¨‹åºç 

æˆ‘ä»¬é‡‡ç”¨äº‘è°ƒç”¨çš„æ–¹å¼ç”Ÿæˆå°ç¨‹åºç ,è¯¦ç»†å‚æ•°è¯´æ˜çœ‹[æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/qr-code.html)ï¼Œä¸‹é¢åªé‡‡ç”¨å…¶ä¸­ä¸€ç§æ–¹æ³•ç”Ÿæˆå°ç¨‹åºç 

* åœ¨åˆ›å»ºäº‘å‡½æ•°`getQrCode`,é…ç½®`config.json`æ–‡ä»¶å¼€å¯ç”Ÿæ•ˆç”Ÿæˆå°ç¨‹åºç çš„èƒ½åŠ›

```json
{
  "permissions": {
    "openapi": [
      "wxacode.getUnlimited"
    ]
  }
}
```



* åœ¨äº‘å‡½æ•°ç”Ÿæˆå°ç¨‹åºç ï¼Œç”±äº`cloud.openapi.wxacode.getUnlimited`æ¥å£è¿”å›çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨äº‘å­˜å‚¨çš„èƒ½åŠ›ç”Ÿæˆä¸€ä¸ªç”µè„‘èƒ½è¯†åˆ«çš„å›¾ç‰‡æ ¼å¼

```js
const cloud = require('wx-server-sdk')
cloud.init()
exports.main = async (event, context) => {
    const result = await cloud.openapi.wxacode.getUnlimited({
        scene: 'a=1'
    })
    const upload = await cloud.uploadFile({
        cloudPath:'qrcode/'+Date.now() + '-' + Math.random()*1000 + '.png',
        fileContent: result.buffer
    })
    return upload.fileID
}
```

* å°ç¨‹åºè°ƒç”¨,ç»™æŒ‰é’®æ³¨å†Œ`bindtap="onTapQrCode"`äº‹ä»¶å³å¯

```js
async onTapQrCode() {
    wx.showLoading({
        title: 'å°ç¨‹åºç æ­£åœ¨ç”Ÿæˆ',
    })
    let codeInfo = await wx.cloud.callFunction({
        name:'getQrCode',
        data:{
            openId: app.globalData.openId
        }
    })
    wx.hideLoading()
    wx.previewImage({
        urls: [codeInfo.result],
        current: codeInfo.result
    })
},
```

 ## åä¸‰ã€äº‘æ•°æ®åº“è®¾è®¡1å¯¹Nçš„å…³ç³»

### 13.1 åœ¨1è¡¨å­˜æ”¾N

è¿™ç§æƒ…å†µé€‚åˆ`N`ä¸å¤šçš„æ—¶å€™ï¼Œä¾‹å¦‚ï¼šåœ¨ä¸€ä¸ªåšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬é™åˆ¶äº†ä¸€ä¸ªæ–‡ç« æœ€å¤šåªèƒ½ä¸Šä¼ 9å¼ å›¾ç‰‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬èƒ½è§9å¼ å›¾ç‰‡çš„`formId`ä½œä¸ºä¸€ä¸ªæ•°ç»„å­˜æ”¾åœ¨åšå®¢ä¸­

```js
{
 "_id":"a7d38b365f0a8118001c7539133ef363"
 "_openid":"ooKTI5X9SJfvuowAo7S2R9qAKhZo"
"content":""""
"createTime":Sun Jul 12 2020 11:18:48 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)
"img":["cloud://liuxcx-uxzb1.6c69-liuxcx-uxzb1-1302594979/blog/15..."
"cloud://liuxcx-uxzb1.6c69-liuxcx-uxzb1-1302594979/blog/15..."
"cloud://liuxcx-uxzb1.6c69-liuxcx-uxzb1-1302594979/blog/15..."]
}
```

###13.2 åœ¨1 è¡¨ä¸­å­˜æ”¾Nçš„å”¯ä¸€æ ‡è¯†

è¿™ç§æƒ…å†µä¸‹é€‚åˆ`N`ä¸è¾ƒå¤šçš„æƒ…å†µï¼Œä¾‹å¦‚ä¸€ä¸ªäº§å“å’Œå®ƒçš„é›¶ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†äº§å“å’Œé›¶ä»¶éƒ½åšå‡ºä¸¤ä¸ªè¡¨ï¼Œåœ¨äº§å“ä¸­å­˜æ”¾é›¶ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è”åˆæŸ¥è¯¢å¾—åˆ°æ‰€è¦çš„æ‰€æœ‰å€¼

### 13.3 åœ¨Nè¡¨ä¸­å­˜å‚¨1çš„å”¯ä¸€æ ‡è¯†

è¿™ç§æƒ…å†µä¸‹é€‚åˆ1ä¸ªå¯¹å¤šä¸ªå…¶ä»–ï¼Œä¾‹å¦‚ä¸€ä¸ªåšå®¢çš„è¯„è®ºï¼Œæˆ‘ä»¬çŸ¥é“åšå®¢çš„æ–‡ç« ä¸‹å¯ä»¥æœ‰å¾ˆå¤šçš„è¯„è®ºï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å°†åšå®¢çš„å”¯ä¸€æ ‡è¯†å­˜æ”¾åœ¨è¯„è®ºè¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µä¸Šï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ç”¨åšå®¢çš„å”¯ä¸€æ ‡è¯†åœ¨è¯„è®ºè¡¨ä¸­æŸ¥è¯¢åˆ°è¯¥åšå®¢æ‰€æœ‰è¯„è®ºä¿¡æ¯

## åå››ã€äº‘æ•°æ®åº“æ“ä½œ
### 14.1 äº‘å‡½æ•°çš„æ¨¡ç³ŠåŒ¹é…

æˆ‘ä»¬ä½¿ç”¨`db.RegExp`å¯¹è±¡æ¥åŒ¹é…è§„åˆ™ï¼Œ[æ–‡æ¡£](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference-sdk-api/database/Database.RegExp.html#options%20%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E)

```js
// å¾—åˆ°åšå®¢åˆ—è¡¨
app.router('getBlogList', async (ctx,next)=>{
    const searchValue = event.searchValue
    let w = {}
    if(searchValue.trim().length >0) {
        w = {
            content:db.RegExp({
                regexp:searchValue,
                options:'i'
            })
        }
    }
    ctx.body =  await blogCollection.where(w).skip(event.start).limit(event.end).orderBy('createTime','desc').get()
})
```

### 14.2 äº‘æ•°æ®åº“çš„è”åˆæŸ¥è¯¢

> ç”±äºäº‘æ•°æ®è¿˜ä¸æ”¯æŒè”åˆæŸ¥è¯¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¾—ç¹çç‚¹ï¼Œæ‰ç”¨å¤šæ¬¡æŸ¥è¯¢æ–¹æ³•æ¥è§£å†³é—®é¢˜

```js
// å¾—åˆ°åšå®¢è¯¦æƒ…
app.router('getBlogDetail',async(ctx,next)=>{
    const blogId = event.blogId

    // è¯¦æƒ…æŸ¥è¯¢
    let detail = await blogCollection.where({
        _id:blogId
    }).get()
    detail = detail.data

    // è¯„è®ºæŸ¥è¯¢ 
    const countResult = await db.collection('blogComment').count()
    const total = countResult.total
    let commentList = {
        data:[]
    }

    if(total>0) {
        const batchTimes = Math.ceil(total / MAX_COMMENT_LENGTH)
        const tasks =[]
        for(let i=0;i<batchTimes;i++) {
            let promise = db.collection('blogComment').skip(i*MAX_COMMENT_LENGTH).limit(MAX_COMMENT_LENGTH).where({
                blogId
            }).orderBy('creataTime','desc').get()
            tasks.push(promise)
        }

        if(tasks.length>0) {
            commentList =  (await Promise.all(tasks)).reduce((acc,cur)=>{
                return {
                    data:acc.data.concat(cur.data)
                }
            })
        }
	
        ctx.body = {
            commentList,
            detail
        }
    }
})
```



##åäº”ã€é€šè¿‡HTTP API è°ƒç”¨å°ç¨‹åºäº‘æœåŠ¡

è¿™ä¸ªç« èŠ‚æˆ‘ä»¬ç”¨ä¸€ä¸ªåå°ç®¡ç†ç³»ç»Ÿä¸ºä¾‹å­è¿›è¡Œè®²è¿°ï¼Œç”¨åˆ°`vue-admin-template`æ„å»ºç³»ç»Ÿå‰ç«¯ï¼Œç”¨`koa`æ¥æ„å»ºç³»ç»Ÿåç«¯

### 15.1 é¡¹ç›®å‡†å¤‡

å‰ç«¯å‡†å¤‡:

* å®‰è£…`vue-admin-template`ï¼Œ[github](https://github.com/PanJiaChen/vue-admin-template/blob/master/README-zh.md)
* å®‰è£…åŸºç¡€ç‰ˆ
* å°†srcä¸‹çš„é™¤äº†`404.vue`å’Œ`login.vue`ä¿å­˜ä¹‹åå…¨éƒ¨æ¸…é™¤ï¼Œåœ¨`router`ç›®å½•ä¸‹ä¿®æ”¹å¥½è·¯ç”±è·¯å¾„

åç«¯å‡†å¤‡:

* å®‰è£…ä¾èµ–

```bash
npm i koa koa-router koa2-cors koa-body request request-promise -S
```

å¯¹åº”çš„ä½œç”¨:

> koa ----------------> nodeæ¡†æ¶
>
> koa-router ------> è·¯ç”±ç®¡ç†
>
> koa2-cors -------> è§£å†³è·¨åŸŸé—®é¢˜
>
> koa-bofu --------> æ¥å—postçš„è¯·æ±‚ä½“å†…å®¹
>
> requset  å’Œ request-promise -------> å‘é€ç½‘ç»œè¯·æ±‚

### 15.2 access_token 

ç”±äºæˆ‘ä»¬ä¸åœ¨å°ç¨‹åºå†…è°ƒç”¨äº‘æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œéƒ½è¦æºå¸¦ä¸€ä¸ª`access_token`åˆ°å°ç¨‹åºæœåŠ¡å™¨ä¸Šå½“åšå‡­è¯ï¼Œæ‰èƒ½å¯åŠ¨æœåŠ¡ï¼Œè€Œä¸”æ¯æ¬¡å¾—åˆ°`access_token`æœ‰æ•ˆæœŸåªæœ‰`7200ç§’`(2ä¸ªå°æ—¶)ï¼Œæˆ‘ä»¬èƒ½æ‰ç”¨nodeæä¾›çš„èƒ½åŠ›å°†å®ƒå†™å…¥ä¸€ä¸ª`.json`æ–‡ä»¶ä¸Šï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™åœ¨è¯»å–å†…å®¹åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œå½“ç„¶ä¹Ÿèƒ½å­˜å–åˆ°æ•°æ®åº“ä¸­å»ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨`json`æ–‡ä»¶çš„æ–¹å¼ï¼Œå­˜å–ä»£ç å¦‚ä¸‹

```js
const rp = require('request-promise')
const APPID = 'å†™è‡ªå·±çš„'
const APPSECRET = 'å†™è‡ªå·±çš„'
const URL = `https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=${APPID}&secret=${APPSECRET}`
const fs = require('fs')
const path = require('path')
const fileName = path.resolve(__dirname, './access_token.json')
// æ›´æ–°tokenæ–¹æ³•
const updateAccessToken = async () => {
    // å‘é€è¯·æ±‚
    const resStr = await rp(URL)
    const res = JSON.parse(resStr)
    // å†™æ–‡ä»¶
    if (res.access_token) {
        fs.writeFileSync(fileName, JSON.stringify({
            access_token: res.access_token,
            createTime: new Date()
        }))
    } else {
        await updateAccessToken()
    }
}
// å¾—åˆ°tokenæ–¹æ³•
const getAccessToken = async () => {
    // è¯»å–æ–‡ä»¶
    try {
        const readRes = fs.readFileSync(fileName, 'utf8')
        const readObj = JSON.parse(readRes)
        const createTime = new Date(readObj.createTime).getTime()
        const nowTime = new Date().getTime()
        // åˆ¤æ–­tokenæ˜¯å¦è¿‡æœŸ
        if ((nowTime - createTime) / 1000 / 60 / 60 >= 2) {
            await updateAccessToken()
            await getAccessToken()
        }
        return readObj.access_token
    } catch (error) {
        // è‹¥å½“å‰è¿˜æœªæœ‰jsonæ–‡ä»¶ï¼Œåˆ™å»åˆ›å»ºå¹¶è·å–åˆ°token
        await updateAccessToken()
        await getAccessToken()
    }
}

// æ¯ä¸¤ä¸ªå°æ—¶æ›´æ–°ä¸€æ¬¡
setInterval(async () => {
    await updateAccessToken()
}, (7200 - 300) * 1000)

module.exports = getAccessToken
```

### 15.3 è°ƒç”¨äº‘å‡½æ•°

å…¶å®è°ƒç”¨äº‘å‡½æ•°è¿‡ç¨‹åŸºæœ¬ä¸€è‡´ï¼Œæˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ªæ–¹æ³•,å¦‚ä¸‹ï¼š

```js
// å¾—åˆ°tokenå€¼
const getAccessToken = require('./getAccessToken.js')
const rp = require('request-promise')

/* 
	ctx æ˜¯koaé€šè¿‡çš„ä¸­é—´ä»¶ä¸Šä¸‹æ–‡ï¼Œä¸€èˆ¬æˆ‘ä»¬æŠŠå°ç¨‹åºç¯å¢ƒååœ¨å…¨å±€ä¸­é—´ä»¶åŠ åˆ°ctxä¸Šå»
	fnName æ˜¯è¦è°ƒç”¨çš„å°ç¨‹åºå‡½æ•°
	params ä¼ é€’ç»™äº‘å‡½æ•°çš„å‚æ•° ä¾‹å¦‚è¦è°ƒç”¨é‚£ä¸ªè·¯ç”±ï¼Œåˆ†é¡µçš„è·³è¿‡å‡ æ¡æˆ–è·å–å‡ æ¡
*/

const callCloudFn = async (ctx, fnName, params) => {
    const ACCESS_TOKEN = await getAccessToken()
    const options = {
        method: 'POST',
        uri: `https://api.weixin.qq.com/tcb/invokecloudfunction?access_token=${ACCESS_TOKEN}&env=${ctx.state.env}&name=${fnName}`,
        body: {
            ...params
        },
        json: true // Automatically stringifies the body to JSON
    }

    return await rp(options)
        .then((res) => {
        return res
    })
        .catch(function (err) {
    })
}

module.exports = callCloudFn
```

### 15.4 è°ƒç”¨äº‘æ•°æ®åº“

æˆ‘ä»¬ä¹Ÿå°è£…ä¸€ä¸ªæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹

```js
// å¾—åˆ°token
const getAccessToken = require('./getAccessToken.js')
const rp = require('request-promise')

/*
	ctx æ˜¯koaé€šè¿‡çš„ä¸­é—´ä»¶ä¸Šä¸‹æ–‡ï¼Œä¸€èˆ¬æˆ‘ä»¬æŠŠå°ç¨‹åºç¯å¢ƒååœ¨å…¨å±€ä¸­é—´ä»¶åŠ åˆ°ctxä¸Šå»
	fnName æ˜¯è¦æ“ä½œæ•°æ®åº“çš„ç±»å‹
	query æ˜¯è¦å¯¹æ•°æ®åº“çš„æ“ä½œè¯­å¥
*/
const callCloudDB = async(ctx, fnName, query = {}) => {
    const ACCESS_TOKEN = await getAccessToken()
    const options = {
        method: 'POST',
        uri: `https://api.weixin.qq.com/tcb/${fnName}?access_token=${ACCESS_TOKEN}`,
        body: {
            query,
            env: ctx.state.env,
        },
        json: true // Automatically stringifies the body to JSON
    }

    return await rp(options)
        .then((res) => {
        return res
    })
        .catch(function (err) {
        console.log(err);
    })

}

module.exports = callCloudDB
```

### 15.5 äº‘å‡½æ•°å’Œäº‘æ•°æ®åº“çš„è°ƒç”¨æ¡ˆä¾‹

ä¾‹å¦‚æˆ‘ä»¬`playListçš„è°ƒç”¨`

```js
const Router = require('koa-router')
const router = new Router()
const callCloudFn = require('../utils/callCloudFn')
const callCloudDB = require('../utils/callCloudDB.js')
// get post
router.get('/list', async (ctx, next) => {
    // å¾—åˆ°getæºå¸¦è¿‡æ¥çš„å‚æ•°
    const query = ctx.request.query
    // è°ƒç”¨äº‘å‡½æ•°musicä¸‹çš„playlistè·¯ç”±
    const res = await callCloudFn(ctx, 'music', {
        $url: 'playlist',
        start: parseInt(query.start),
        count: parseInt(query.count)
    })
    let data = []
    if (res.resp_data) {
        data = JSON.parse(res.resp_data).data
    }
    ctx.body = {
        data,
        code: 20000, // ä½¿ç”¨ vue-admin-templateæ¨¡æ¿çš„æ—¶å€™åå°ä¸€å®šè¦è¿”å›code:20000ï¼Œä¸ç„¶æ¨¡æ¿ä¼šæŠ¥é”™
    }
})

router.get('/getById', async(ctx, next)=>{
    const query = `db.collection('playlist').doc('${ctx.request.query.id}').get()`
    // è°ƒç”¨äº‘æ•°æ®palylisté›†åˆï¼Œå¹¶æ˜¯æŸ¥è¯¢æ“ä½œ 
    const res = await callCloudDB(ctx, 'databasequery', query)
    ctx.body = {
        code: 20000,
        data: JSON.parse(res.data)
    }
})

router.post('/updatePlaylist', async(ctx, next)=>{
    const params = ctx.request.body
    const query = `
db.collection('playlist').doc('${params._id}').update({
data: {
name: '${params.name}',
copywriter: '${params.copywriter}'
}
})
`
    // è°ƒç”¨äº‘æ•°æ®åº“çš„playlisté›†åˆï¼Œå¹¶ä¸”æ˜¯æ›´æ–°æ“ä½œ
    const res = await callCloudDB(ctx, 'databaseupdate', query)
    ctx.body = {
        code: 20000,
        data: res
    }
})

router.get('/del', async(ctx, next)=>{
    const params = ctx.request.query
    const query = `db.collection('playlist').doc('${params.id}').remove()`
     // è°ƒç”¨äº‘æ•°æ®åº“çš„playlisté›†åˆï¼Œå¹¶ä¸”æ˜¯åˆ é™¤æ“ä½œ
    const res = await callCloudDB(ctx, 'databasedelete', query)
    ctx.body = {
        code: 20000,
        data: res
    }
})

module.exports = router
```

### 15.6 è°ƒç”¨äº‘å­˜å‚¨

å¯¹åº”è°ƒç”¨äº‘å­˜å‚¨ï¼Œæˆ‘ä»¬ä¹Ÿå°è£…äº†ä¸€ä¸ªæ–¹æ³•

```js
const getAccessToken = require('./getAccessToken.js')
const rp = require('request-promise')
const fs = require('fs')

const cloudStorage = {
    // å¾—åˆ°ä¸‹è½½å›¾ç‰‡åœ°å€
    async download(ctx, fileList) {
        const ACCESS_TOKEN = await getAccessToken()
        const options = {
            method: 'POST',
            uri: `https://api.weixin.qq.com/tcb/batchdownloadfile?access_token=${ACCESS_TOKEN}`,
            body: {
                env: ctx.state.env,
                file_list: fileList
            },
            json: true
        }

        return await rp(options)
            .then((res) => {
            return res
        })
            .catch(function(err) {
            console.log(err);
        })

    },
	
   // ä¸Šä¼ æ–‡ä»¶
/*
	ä¸Šä¼ å›¾ç‰‡è¦åˆ†ä¸¤ä¸ªæ­¥éª¤
	1. å¾—åˆ°ä¸Šä¼ å›¾ç‰‡çš„æœåŠ¡å™¨åœ°å€
	2. å°†ç¬¬ä¸€æ­¥è¿”å›çš„æ•°æ®è¿›è¡Œä¸€æ¬¡æ‹¼è£…ï¼Œåœ¨å‘é€åˆ°ç¬¬ä¸€æ­¥è¿”å›çš„æœåŠ¡å™¨åœ°å€å­˜å‚¨ï¼Œåœ¨æ‹¼è£…æ•°æ®çš„æ—¶å€™ï¼Œç”±äºæœåŠ¡å™¨åªæ¥å—äºŒè¿›åˆ¶ä¼ è¾“æ•°æ®ï¼Œæ•…æ‹¼è£…æ•°æ®çš„ fileå±æ€§æˆ‘ä»¬é‡‡ç”¨ fs.createReadStream()æ–¹æ³•è½¬åŒ–
*/   

    async upload(ctx) {
        // 1ã€è¯·æ±‚åœ°å€
        const ACCESS_TOKEN = await getAccessToken()
        const file = ctx.request.files.file
        const path = `swiper/${Date.now()}-${Math.random()}-${file.name}`
        const options = {
            method: 'POST',
            uri: `https://api.weixin.qq.com/tcb/uploadfile?access_token=${ACCESS_TOKEN}`,
            body: {
                path,
                env: ctx.state.env,
            },
            json: true // Automatically stringifies the body to JSON
        };
        //  è¯·æ±‚å‚æ•°çš„
        const info = await rp(options)
        .then(function(res) {
            return res
        })
        .catch(function(err) {})
        console.log(info)
        // 2ã€ä¸Šä¼ å›¾ç‰‡
        const params = {
            method: 'POST',
            headers: {
                'content-type': 'multipart/form-data'
            },
            uri: info.url,
            formData: {
                key: path,
                Signature: info.authorization,
                'x-cos-security-token': info.token,
                'x-cos-meta-fileid': info.cos_file_id,
                file: fs.createReadStream(file.path)
            },
            json: true
        }
        await rp(params) // è¿”å›æ˜¯ä¸ªç©º
        return info.file_id
    },
// åˆ é™¤å›¾ç‰‡
    async delete(ctx, fileid_list) {
        const ACCESS_TOKEN = await getAccessToken()
        const options = {
            method: 'POST',
            uri: `https://api.weixin.qq.com/tcb/batchdeletefile?access_token=${ACCESS_TOKEN}`,
            body: {
                env: ctx.state.env,
                fileid_list: fileid_list
            },
            json: true
        }

        return await rp(options)
            .then((res) => {
            return res
        })
            .catch(function(err) {
            console.log(err);
        })
    }
}

module.exports = cloudStorage
```

ä¾‹å¦‚`swiper`çš„è°ƒç”¨

```js
const Router = require('koa-router')
const router = new Router()
const callCloudDB = require('../utils/callCloudDB.js')
const cloudStorage = require('../utils/callCloudStorage.js')

router.get('/list', async (ctx, next) => {
    // é»˜è®¤10æ¡æ•°æ®
    const query = `db.collection('swiper').get()`
    const res = await callCloudDB(ctx, 'databasequery', query)
    console.log(res)
    // ç”±äºäº‘æ•°æ®åº“çš„å­˜å‚¨çš„åœ°å€ä¸èƒ½åœ¨æˆ‘ä»¬æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œæˆ‘ä»¬å¾—å»å°ç¨‹åºæœåŠ¡å™¨ä¸Šè·Ÿæ¢åœ°å€
    let fileList = []
    const data = res.data
    for (let i = 0, len = data.length; i < len; i++) {
        fileList.push({
            fileid: JSON.parse(data[i]).fileid,
            max_age: 7200
        })
    }
    const dlRes = await cloudStorage.download(ctx, fileList)
    console.log(dlRes)
    let returnData = []
    for (let i = 0, len = dlRes.file_list.length; i < len; i++) {
        returnData.push({
            // download_url æˆ‘ä»¬æµè§ˆå™¨ä¸­èƒ½å¤Ÿä½¿ç”¨çš„è·¯å¾„åœ°å€
            download_url:  dlRes.file_list[i].download_url,
            // äº‘å­˜å‚¨ä¸­çš„å”¯ä¸€æ ‡è¯†
            fileid: dlRes.file_list[i].fileid,
            _id: JSON.parse(data[i])._id
        })
    }
    ctx.body = {
        code: 20000,
        data: returnData
    }
})

router.post('/upload', async(ctx, next)=>{
    const fileid =  await cloudStorage.upload(ctx)
    console.log(fileid)
    // å†™æ•°æ®åº“
    const query = `
db.collection('swiper').add({
data: {
fileid: '${fileid}'
}
})
`
    const res = await callCloudDB(ctx, 'databaseadd', query)
    ctx.body = {
        code: 20000,
        id_list: res.id_list
    }
})

router.get('/del', async (ctx, next)=>{
    const params = ctx.request.query
    // åˆ é™¤äº‘æ•°æ®åº“ä¸­çš„å†…å®¹
    const query = `db.collection('swiper').doc('${params._id}').remove()`
    const delDBRes = await callCloudDB(ctx, 'databasedelete', query)

    // åˆ é™¤äº‘å­˜å‚¨ä¸­çš„æ–‡ä»¶
    const delStorageRes = await cloudStorage.delete(ctx, [params.fileid])
    ctx.body = {
        code: 20000,
        data: {
            delDBRes,
            delStorageRes,
        }
    }
})

module.exports = router
```



## åŸç”Ÿç»„ä»¶

### textarea 

```html
  <textarea class="content" placeholder="åˆ†äº«æ–°é²œäº‹..." maxlength="140" bindinput="inputHandler" bindfocus="onFocus" bindblur="onBlur"></textarea>
```

* maxlength ->  å¡«å†™æœ€å¤§å­—æ•°
* bindinput  -> è¾“å…¥å­—è§¦å‘äº‹ä»¶
* bindfocus -> è·å–ç„¦ç‚¹è§¦å‘
* bindblur  -> å¤±å»ç„¦ç‚¹è§¦å‘

åœ¨`bindfoucus`äº‹ä»¶ä¸­å¯ä»¥è·å–è¯¥è®¾å¤‡é”®ç›˜çš„é«˜åº¦

```js
// ç›‘å¬ç„¦ç‚¹
onFocus(e) {
   	// å¾—åˆ°è®¾å¤‡é”®ç›˜é«˜åº¦
  console.log(e.detail.height)
  this.setData({
    keyWordHeight:e.detail.height
  })
},
onBlur() {
  this.setData({
    keyWordHeight: 0
  })
},
```

##è°ƒç”¨ä¸Šä¸€ä¸ªé¡µé¢çš„æ–¹æ³•

æˆ‘ä»¬é‡‡ç”¨[getCurrentPages()](https://developers.weixin.qq.com/miniprogram/dev/reference/api/getCurrentPages.html)è·å–å½“å‰é¡µé¢æ ˆã€‚æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºé¦–é¡µï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä¸ºå½“å‰é¡µé¢ã€‚ 

ä¾‹å¦‚æˆ‘ä»¬æ‰ç”¨ä¸Šä¸€ä¸ªé¡µé¢çš„ä¸‹æ‹‰åˆ·æ–°æ›´æ–°

```js
const page = getCurrentPages()
const prePage = page[page.length-2]
prePage.onPullDownRefresh()
```

##æ—¶é—´æ ¼å¼åŒ–å¤„ç†

åœ¨`utils`ç›®å½•ä¸‹å»ºç«‹`formatTime.js`æ–‡ä»¶ä½œä¸ºå·¥å…·å‡½æ•° ï¼Œå…¶å‚æ•°ä¼ å…¥æ˜¯`GMTæ—¥æœŸ` ä¾‹å¦‚`Mon Jul 13 2020 13:55:47 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´)`

```js
module.exports = (date) => {
    let fmt = 'yyy-MM-dd hh:mm:ss'
    const o = {
        'M+': date.getMonth() +1,//æœˆä»½
        'd+': date.getDate(), // æ—¥
        'h+': date.getHours(),// å°æ—¶
        'm+': date.getMinutes(), // åˆ†é’Ÿ
        's+': date.getSeconds() , // ç§’
    }

    if(/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1,date.getFullYear())
    }

    for(let k in o) {
        if(new RegExp('('+ k + ')').test(fmt)) {
            fmt = fmt.replace(RegExp.$1,o[k].toString().length == 1? '0' + o[k] :o[k])
        }
    }

    return fmt
}
```




## å°ç¨‹åºç«¯å’Œäº‘å‡½æ•°è°ƒç”¨äº‘æ•°æ®åº“çš„å·®åˆ«

1. åœ¨äº‘æ•°æ®åº“çš„ç®¡ç†æƒé™æ–¹ä¾¿
   * äº‘è°ƒç”¨æ—¶ï¼Œå§‹ç»ˆæœ‰æ‰€æœ‰æ•°æ®è¯»å†™æƒé™
   * å°ç¨‹åºç«¯è°ƒç”¨ï¼Œé»˜è®¤æ˜¯ æ•°æ®æ˜¯åªå¯¹åˆ›å»ºè€…å¯è¯»å¯å†™

2. å¾—åˆ°æœåŠ¡å™¨çš„æ—¶é—´ä¸åŒ
   * äº‘å‡½æ•°è°ƒç”¨å¾—åˆ°çš„æœåŠ¡å™¨æ—¶é—´æ˜¯`GMT`æ—¶é—´ç±»å‹
   * å°ç¨‹åºè°ƒç”¨å¾—åˆ°çš„æ˜¯ä¸ªç©ºå¯¹è±¡

3. å®ä¾‹åŒ–å¯¹è±¡

   * å°ç¨‹åº

   ```js
   const db = wx.cloud.database().collection('gruel-course')
   ```

   * äº‘å‡½æ•°

   ```js
   const db = cloud.database().collection('gruel-course')
   ```

## å¢åŠ è§¦å‘å™¨

åœ¨`config.json`æ–‡ä»¶ä¸‹å¢åŠ èŠ‚ç‚¹ï¼Œå¹¶ä¸€å®šå³é”®ç‚¹å‡»**ä¸Šä¼ è§¦å‘å™¨**æ‰èƒ½ç”Ÿæ•ˆ

```json
{
  "triggers":[
    {
    "name":"myTrigger",
    "type":"timer",
    "config":"0 0 10,14,16,23 * * * *"
    }
  ]
}
```



## è·å–å…¨å±€æ•°æ®

åœ¨å°ç¨‹åºçš„`app.js`ä¸‹æœ‰ä¸€ä¸ªå±æ€§èŠ‚ç‚¹`globalData`ä¸‹é¢å­˜æ”¾ç€å…¨å±€æ•°æ®ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªé¡µé¢æˆ–ç»„ä»¶ä¸­å¯æ‰ç”¨`const app = getApp()`é€šè¿‡è¿™ä¸ªå¯¹è±¡`app.globalData.xxx`è·å–åˆ°å…¨å±€çš„å±æ€§å€¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒè°ƒç”¨`app.js`ä¸­å£°æ˜çš„æ‰€æœ‰å±æ€§å€¼å’Œæ–¹æ³• 

##äº‘å‡½æ•°ä¸Šæ—¶é—´é—®é¢˜

äº‘å‡½æ•°ä¸­çš„æ—¶åŒºä¸º UTC+0ï¼Œä¸æ˜¯ UTC+8ï¼Œåœ¨äº‘å‡½æ•°ä¸­ä½¿ç”¨æ—¶é—´æ—¶éœ€ç‰¹åˆ«æ³¨æ„ã€‚ä¹Ÿå°±æ˜¯æ˜¯è¯´ï¼Œç°åœ¨æ˜¯2020-05-25 15:00:00ï¼Œä½†æ˜¯åœ¨äº‘å‡½æ•°ç«¯new Date()æ‰“å°çš„æ˜¯2020-05-25 07:00:00 ï¼Œå¦‚æœéœ€è¦é»˜è®¤ UTC+8ï¼Œå¯ä»¥é…ç½®å‡½æ•°çš„ç¯å¢ƒå˜é‡ï¼Œè®¾ç½® TZ ä¸º Asia/Shanghaiã€‚ 

**æ³¨æ„äº‹é¡¹**

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šè®¾ç½®ç¯å¢ƒå˜é‡å’Œä¸Šä¼ äº‘å‡½æ•°çš„é¡ºåºé—®é¢˜ï¼Œä¸€å®šè¦åœ¨è®¾ç½®ç¯å¢ƒå˜é‡ä¹‹åï¼Œé‡æ–°éƒ¨ç½²äº‘å‡½æ•°ï¼Œå¹¶ä¸”éƒ¨ç½²å®Œæˆä¹‹åè¦ç¼“ä¸ªå‡ åˆ†é’Ÿæµ‹è¯•ï¼Œ

## é˜²æŠ–

è°ƒç”¨çš„æ—¶å€™ä¼ å…¥è·å–æ•°æ®çš„å‡½æ•°

```js
const scroll = {
    isEnd: false,
    start(callback) {
        let timer = null
        callback && window.addEventListener('scroll', () => {
            if (timer) {
                clearTimeout(timer)
            }
            // å‡½æ•°é˜²æŠ–
            timer = setTimeout(() => {
                // æµè§ˆå™¨å‘ä¸Šæ»šåŠ¨çš„é«˜åº¦
                const scrollTop = document.documentElement.scrollTop || document.body.scrollTop
                // æ–‡æ¡£çš„çœŸå®é«˜åº¦
                const scrollHeight = document.documentElement.scrollHeight
                // æµè§ˆå™¨çª—å£ï¼ˆæ–‡æ¡£ï¼‰çš„å¯è§†é«˜åº¦,å°±æ˜¯è‚‰çœ¼å¯è§çš„é‚£éƒ¨åˆ†å…¨å±é«˜åº¦
                const clientHeight = document.documentElement.clientHeight
                if (!this.isEnd && scrollHeight == Math.floor(scrollTop) + clientHeight) {
                    console.log('æŸ¥è¯¢æ•°æ®')
                    window.scrollTo(0, scrollTop - 50)
                    // è¯·æ±‚æ•°æ®
                    callback()
                }
            }, 300)
        })
    },
    end() {
        this.isEnd = true
    }
}

export default scroll
```

